@startuml Class Diagram - Server Module
!theme plain
skinparam backgroundColor #FFFFFF
skinparam class {
  BackgroundColor #E1F5FF
  BorderColor #0066CC
  ArrowColor #0066CC
}

title Class Diagram - Server Module

package "com.promex04.model" {
  class User {
    -Long id
    -String username
    -String password
    -Integer totalScore
    -Integer correctAnswers
    -Integer gamesWon
    -Integer gamesPlayed
    +User(String username, String password)
  }

  class Game {
    -Long id
    -User player1
    -User player2
    -Integer player1Score
    -Integer player2Score
    -Integer currentRound
    -GameStatus status
    -LocalDateTime createdAt
    -LocalDateTime finishedAt
    -User winner
    -String preferredArtist
    -String preferredGenre
    --
    +enum GameStatus
  }

  class GameRound {
    -Long id
    -Game game
    -AudioSegment audioSegment
    -Integer roundNumber
    -Integer player1Answer
    -Integer player2Answer
    -Long player1TimeMs
    -Long player2TimeMs
    -Integer player1Points
    -Integer player2Points
    -String option1
    -String option2
    -String option3
    -String option4
    -Integer correctAnswer
    -LocalDateTime startedAt
    -LocalDateTime finishedAt
  }

  class Audio {
    -Long id
    -String name
    -String filePath
    -Artist artist
    -Genre genre
    -List<AudioSegment> segments
  }

  class Artist {
    -Long id
    -String name
    -List<Audio> audios
  }

  class Genre {
    -Long id
    -String name
    -List<Audio> audios
  }

  class AudioSegment {
    -Long id
    -Audio audio
    -Integer startTime
    -Integer endTime
    -String filePath
  }
}

package "com.promex04.repository" {
  interface UserRepository {
    +Optional<User> findByUsername(String username)
    +List<User> findAllOrderByRanking()
    +User save(User user)
  }

  interface GameRepository {
    +Game save(Game game)
    +Optional<Game> findById(Long id)
    +List<Game> findByPlayer1UsernameOrPlayer2Username(String player1, String player2)
  }

  interface GameRoundRepository {
    +GameRound save(GameRound round)
    +Optional<GameRound> findById(Long id)
    +Optional<GameRound> findByGameIdAndRoundNumber(Long gameId, Integer roundNumber)
    +List<GameRound> findByGameId(Long gameId)
  }

  interface AudioRepository {
    +List<Audio> findAll()
    +Audio save(Audio audio)
  }

  interface ArtistRepository {
    +Optional<Artist> findByName(String name)
    +List<Artist> searchByName(String keyword)
  }

  interface GenreRepository {
    +Optional<Genre> findByName(String name)
    +List<Genre> searchByName(String keyword)
  }

  interface AudioSegmentRepository {
    +List<AudioSegment> findByAudioId(Long audioId)
    +List<AudioSegment> findAllWithAudio()
  }
}

package "com.promex04.service" {
  class UserService {
    -UserRepository userRepository
    +Optional<User> authenticate(String username, String password)
    +Optional<User> findByUsername(String username)
    +User createUser(String username, String password)
    +List<User> getRanking()
    +void updateUserStats(User user, boolean won, int score, int correctAnswers)
    +User save(User user)
  }

  class GameService {
    -GameRepository gameRepository
    -GameRoundRepository gameRoundRepository
    -AudioRepository audioRepository
    -AudioSegmentRepository audioSegmentRepository
    -ArtistRepository artistRepository
    -GenreRepository genreRepository
    -UserService userService
    +Game createGame(User player1, User player2)
    +Game createGame(User player1, User player2, String preferredArtist, String preferredGenre)
    +AudioSegment getRandomAudioSegment()
    +List<AudioSegment> getRandomAudioSegments(int n)
    +List<AudioSegment> getRandomAudioSegments(int n, String preferredArtist, String preferredGenre)
    +List<String> getDistinctArtists()
    +List<String> getDistinctGenres()
    +List<String> searchArtists(String keyword)
    +List<String> searchGenres(String keyword)
    +GameRound createRound(Game game, int roundNumber)
    +GameRound createRoundWithSegment(Game game, int roundNumber, AudioSegment segment)
    +GameRound findOrCreateRoundWithSegment(Game game, int roundNumber, AudioSegment segment)
    +RoundResult processRoundAnswer(GameRound round, String playerUsername, int answerIndex, long timeMs)
    +boolean isRoundComplete(GameRound round)
    +Game finishGame(Game game)
    +Game finishGameByForfeit(Game game, User leaver)
    --
    +class RoundResult
  }

  class ClientHandler {
    -Socket socket
    -ClientManager clientManager
    -UserService userService
    -GameService gameService
    -User currentUser
    -boolean inGame
    -Game currentGame
    -GameRound currentRound
    +void run()
    -void handleMessage(String message)
    -void handleLogin(String[] parts)
    -void handleChallenge(String[] parts)
    -void handleGameSubmit(String[] parts)
    -void sendMessage(String message)
  }

  class ClientManager {
    -Map<String, ClientHandler> connectedClients
    -UserService userService
    +void addClient(String username, ClientHandler handler)
    +void removeClient(String username)
    +ClientHandler getClient(String username)
    +void broadcastLobbyUpdate()
    +void broadcastRanking()
    +void broadcastToLobby(String message)
  }

  class SocketServerService {
    -int port
    -ClientManager clientManager
    -UserService userService
    -GameService gameService
    +void start()
    -void acceptConnections()
  }

  class BinaryTransferService {
    -ConcurrentHashMap<String, FileData> fileCache
    -int binaryTransferPort
    -ServerSocket serverSocket
    -ExecutorService executorService
    +void startBinaryTransferServer()
    +int registerFileForTransfer(String filePath, byte[] fileData)
    +int getBinaryTransferPort()
    +String getNormalizedPath(String filePath)
    --
    +class FileData
  }
}

' Relationships
User "1" -- "*" Game : player1
User "1" -- "*" Game : player2
User "1" -- "*" Game : winner
Game "1" -- "*" GameRound
GameRound "1" -- "1" AudioSegment
AudioSegment "N" -- "1" Audio
Audio "N" -- "1" Artist
Audio "N" -- "1" Genre

UserRepository ..|> User : manages
GameRepository ..|> Game : manages
GameRoundRepository ..|> GameRound : manages
AudioRepository ..|> Audio : manages
ArtistRepository ..|> Artist : manages
GenreRepository ..|> Genre : manages
AudioSegmentRepository ..|> AudioSegment : manages

UserService --> UserRepository : uses
GameService --> GameRepository : uses
GameService --> GameRoundRepository : uses
GameService --> AudioRepository : uses
GameService --> AudioSegmentRepository : uses
GameService --> ArtistRepository : uses
GameService --> GenreRepository : uses
GameService --> UserService : uses

ClientHandler --> UserService : uses
ClientHandler --> GameService : uses
ClientHandler --> BinaryTransferService : uses
ClientHandler --> ClientManager : uses
ClientHandler --> User : currentUser
ClientHandler --> Game : currentGame
ClientHandler --> GameRound : currentRound

ClientManager --> ClientHandler : manages
ClientManager --> UserService : uses

SocketServerService --> ClientManager : uses
SocketServerService --> UserService : uses
SocketServerService --> GameService : uses

BinaryTransferService --> BinaryTransferService.FileData : manages

@enduml


@startuml Sequence Diagram Challenge
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequence {
  ArrowColor #0066CC
  LifeLineBorderColor #0066CC
  LifeLineBackgroundColor #E1F5FF
}

title Sequence Diagram - Challenge System

actor "Người chơi 1" as Player1
participant "LobbyView" as Lobby1
participant "GameController" as Controller1
participant "Socket" as Socket1
participant "ClientHandler" as Handler1
participant "ClientManager" as ClientManager
participant "ClientHandler" as Handler2
participant "Socket" as Socket2
participant "GameController" as Controller2
participant "LobbyView" as Lobby2
actor "Người chơi 2" as Player2
participant "GameService" as GameService

Player1 -> Lobby1: Chọn người chơi và chủ đề
Lobby1 -> Lobby1: promptChallengePreference()
Lobby1 -> Controller1: challenge(opponentUsername, artist, genre, totalRounds)
Controller1 -> Socket1: Gửi "CHALLENGE:opponentUsername:payload"

Socket1 -> Handler1: Nhận message
Handler1 -> Handler1: handleChallenge(parts)
Handler1 -> ClientManager: getClient(opponentUsername)
ClientManager --> Handler1: Handler2

Handler1 -> Handler1: Lưu pendingArtist, pendingGenre, totalRounds
Handler1 -> Handler2: pendingArtist, pendingGenre, totalRounds
Handler1 -> Socket2: Gửi "CHALLENGE_REQUEST:challengerUsername:payload"

Socket2 -> Controller2: Nhận message
Controller2 -> Controller2: handleChallengeRequest(parts)
Controller2 -> Lobby2: onChallengeReceived callback
Lobby2 -> Player2: Hiển thị dialog thách đấu với nút Chấp nhận/Từ chối

alt Người chơi 2 chấp nhận
    Player2 -> Lobby2: Click "Chấp nhận"
    Lobby2 -> Controller2: respondToChallenge(true)
    Controller2 -> Socket2: Gửi "CHALLENGE_RESPONSE:accept"

    Socket2 -> Handler2: Nhận message
    Handler2 -> Handler2: handleChallengeResponse(parts)

    Handler2 -> GameService: createGame(challenger, accepter, artist, genre)
    GameService --> Handler2: Game

    Handler2 -> Handler1: currentGame = game
    Handler2 -> Handler2: currentGame = game
    Handler2 -> Handler2: inGame = true
    Handler1 -> Handler1: inGame = true

    Handler2 -> Socket1: Gửi "CHALLENGE_ACCEPTED:accepterUsername"
    Handler2 -> Socket2: Gửi "CHALLENGE_ACCEPTED:challengerUsername"

    Handler2 -> ClientManager: broadcastLobbyUpdate()
    ClientManager -> Handler1: LOBBY_UPDATE (cả hai đều "bận")
    ClientManager -> Handler2: LOBBY_UPDATE

    Handler2 -> GameService: getRandomAudioSegments(totalRounds, artist, genre)
    GameService --> Handler2: List<AudioSegment> playlist

    Handler1 -> Handler1: myPlaylist = playlist
    Handler2 -> Handler2: myPlaylist = playlist

    Handler1 -> Socket1: Gửi "PREFETCH:path1;path2;..."
    Handler2 -> Socket2: Gửi "PREFETCH:path1;path2;..."

else Người chơi 2 từ chối
    Player2 -> Lobby2: Click "Từ chối"
    Lobby2 -> Controller2: respondToChallenge(false)
    Controller2 -> Socket2: Gửi "CHALLENGE_RESPONSE:reject"

    Socket2 -> Handler2: Nhận message
    Handler2 -> Socket1: Gửi "CHALLENGE_REJECTED:opponentUsername"
    Handler2 -> Socket2: Gửi "CHALLENGE_REJECTED:challengerUsername"

    Socket1 -> Controller1: Nhận CHALLENGE_REJECTED
    Controller1 -> Lobby1: onChallengeRejected callback
    Lobby1 -> Player1: Hiển thị thông báo từ chối
end

@enduml

